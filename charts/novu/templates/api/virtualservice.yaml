apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: {{ printf "%s-%s" .Release.Name "api"  }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" . | nindent 4 }}
spec:
  hosts:
    - {{ (trimPrefix "https://" (trimPrefix "http://" .Values.api.env.API_ROOT_URL)) | trimSuffix "/" }}
  gateways:
    - {{ .Values.api.istio.virtualservice.gateway }}
  http:
    - headers:
        request:
          set:
            x-forwarded-host: "{{ (trimPrefix "https://" (trimPrefix "http://" .Values.api.env.API_ROOT_URL)) | trimSuffix "/" }}"
            x-forwarded-proto: "https"
      match:
        - authority:
            exact: {{ (trimPrefix "https://" (trimPrefix "http://" .Values.api.env.API_ROOT_URL)) | trimSuffix "/" }}
      route:
        - destination:
            host: {{ .Values.api.istio.virtualservice.destination }}
            port:
              number: {{ .Values.api.istio.virtualservice.destinationPort }}
      {{- if .Values.api.istio.virtualservice.prefix }}
      match:
        - uri:
            prefix: {{ .Values.api.istio.virtualservice.prefix }}
      {{- end }}
      {{- if .Values.api.istio.virtualservice.rewriteUri }}
      rewrite:
        uri: {{ .Values.api.istio.virtualservice.rewriteUri }}
      {{- end }}
